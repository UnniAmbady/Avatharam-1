<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>HeyGen Viewer (diag)</title>
<style>
  html,body { margin:0; padding:0; background:#0b0e11; height:100%; }
  .wrap { display:flex; align-items:center; justify-content:center; min-height:80vh; }
  video { width:100%; height:auto; max-height:70vh; background:#000; border-radius:14px; }
  .log { font:12px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#e5e7eb;
         background:#111827; border-top:1px solid #374151; padding:10px 12px; white-space:pre-wrap; }
  .ok { color:#22c55e } .warn { color:#f59e0b } .err { color:#ef4444 }
  .bar { position:sticky; top:0; background:#0f172a; padding:6px 10px; border-bottom:1px solid #334155; font:12px; color:#cbd5e1; }
</style>
</head>
<body>
  <div class="bar">Connecting to session…</div>
  <div class="wrap"><video id="v" playsinline autoplay muted></video></div>
  <div id="log" class="log">Boot.</div>

<script>
  // Placeholders replaced by Streamlit:
  const SESSION_TOKEN = "__SESSION_TOKEN__";
  const SESSION_ID    = "__SESSION_ID__";
  const OFFER_SDP_B64 = "__OFFER_SDP_B64__";
  const RTC_CONFIG    = JSON.parse("__RTC_CONFIG__");
  const API_BASE      = "__API_BASE__";

  const bar = document.querySelector(".bar");
  const logEl = document.getElementById("log");
  function setBar(t){ if(bar) bar.textContent = t; }
  function log(t, cls){ const d=document.createElement("div"); if(cls) d.className=cls; d.textContent=t; logEl.appendChild(d); console.log(t); }

  async function postSDP(answerSDP, useBearer=true){
    const url = API_BASE + "/streaming.sdp";
    const headers = { "Content-Type": "application/json", "accept": "application/json" };
    if(useBearer){ headers["Authorization"] = "Bearer " + SESSION_TOKEN; }
    else         { headers["x-api-key"]     = SESSION_TOKEN; } // fallback try

    const body = { session_id: SESSION_ID, sdp: answerSDP };
    log("POST " + url + " " + (useBearer ? "(Bearer)" : "(x-api-key)"));
    const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(body) });
    const txt = await r.text();
    log("SDP status=" + r.status + " body=" + txt.slice(0,240) + (txt.length>240?"…":"") , r.ok?"ok":"err");
    return r.ok;
  }

  async function main(){
    try{
      const offerSDP = atob(OFFER_SDP_B64);
      log("RTC config=" + JSON.stringify(RTC_CONFIG));
      const pc = new RTCPeerConnection(RTC_CONFIG || {});
      pc.addEventListener("connectionstatechange", ()=>log("pc.connectionState="+pc.connectionState));
      pc.addEventListener("iceconnectionstatechange", ()=>log("pc.iceConnectionState="+pc.iceConnectionState));
      pc.addEventListener("signalingstatechange", ()=>log("pc.signalingState="+pc.signalingState));

      pc.addEventListener("track", (ev) => {
        const v = document.getElementById("v");
        if (ev.streams && ev.streams[0]) { v.srcObject = ev.streams[0]; log("Track received", "ok"); setBar("Connected."); }
      });

      pc.addTransceiver("audio", { direction: "recvonly" });
      pc.addTransceiver("video", { direction: "recvonly" });

      await pc.setRemoteDescription({ type:"offer", sdp: offerSDP });
      log("Remote offer set", "ok");
      setBar("Creating local answer…");

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      log("Local answer created", "ok");
      setBar("Submitting SDP to server…");

      let ok = await postSDP(pc.localDescription.sdp, true);
      if(!ok){
        log("Bearer attempt failed, trying x-api-key fallback…", "warn");
        ok = await postSDP(pc.localDescription.sdp, false);
      }
      if(!ok){ setBar("SDP submit failed. See logs below."); return; }

      setBar("Waiting for media…");
      // If ICE never connects, you’ll see it in the log via iceConnectionState changes.

    } catch (e){
      log("Viewer error: " + (e && e.message ? e.message : e), "err");
      setBar("Viewer error. See logs below.");
    }
  }

  // iOS often needs muted autoplay; user can unmute after media flows
  const v = document.getElementById("v");
  v.muted = true;
  main();
</script>
</body>
</html>
